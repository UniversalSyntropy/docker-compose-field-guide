name: Validate

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Install yamllint
        run: pip install yamllint
      - name: Lint YAML files
        run: |
          yamllint -d '{extends: default, rules: {line-length: {max: 300}, truthy: disable, document-start: disable}}' .

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: DavidAnson/markdownlint-cli2-action@v22

  shell-lint:
    name: Shell Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Run ShellCheck
        run: shellcheck scripts/*.sh

  compose-validate:
    name: Compose Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Create required files for validation
        run: |
          mkdir -p secrets
          echo -n "placeholder" > secrets/db_password.txt
          echo -n "placeholder" > secrets/grafana_admin_password.txt
          echo -n "placeholder" > secrets/pihole_password.txt
          echo -n "placeholder" > secrets/nextcloud_db_root_password.txt
          echo -n "placeholder" > secrets/nextcloud_db_password.txt
          echo -n "placeholder" > secrets/nextcloud_admin_password.txt
          cp .env.example .env

      - name: Validate main compose file
        run: docker compose config --quiet

      - name: Validate monitoring compose file
        run: docker compose -f monitoring/docker-compose.yml config --quiet

      - name: Validate recipe compose files
        run: |
          for f in recipes/*.yml; do
            echo "Validating $f..."
            docker compose -f "$f" config --quiet
          done

  line-length:
    name: Giant-Line Regression
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Check for lines exceeding 300 characters
        run: |
          echo "Checking for lines longer than 300 characters..."
          status=0
          while IFS= read -r -d '' file; do
            result=$(awk 'length > 300 {printf "  line %d: %d chars\n", NR, length}' "$file")
            if [ -n "$result" ]; then
              echo "FAIL: $file"
              echo "$result"
              status=1
            fi
          done < <(find . -type f \( -name '*.md' -o -name '*.yml' -o -name '*.yaml' -o -name '*.sh' -o -name '*.json' -o -name '*.jsonc' -o -name '.env*' \) ! -path './.git/*' -print0)
          if [ "$status" -eq 0 ]; then
            echo "PASS: No lines exceed 300 characters."
          fi
          exit "$status"

  stack-test:
    name: Live Stack Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Create required files
        run: |
          mkdir -p secrets
          echo -n "placeholder" > secrets/db_password.txt
          cp .env.example .env

      - name: Start the stack
        run: docker compose up -d

      - name: Wait for containers to initialise
        run: sleep 15

      - name: Verify containers are running
        run: |
          echo "=== Container status ==="
          docker compose ps
          echo ""
          # Check that no container exited or restarted
          unhealthy=$(docker compose ps --format json | \
            python3 -c "
          import sys, json
          bad = []
          for line in sys.stdin:
              line = line.strip()
              if not line:
                  continue
              c = json.loads(line)
              state = c.get('State', '')
              if state not in ('running',):
                  bad.append(f\"{c.get('Name','?')}: {state}\")
          if bad:
              for b in bad:
                  print(f'FAIL: {b}')
              sys.exit(1)
          print('PASS: All containers are running.')
          ")

      - name: Tear down the stack
        if: always()
        run: docker compose down

  link-check:
    name: Link Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: lycheeverse/lychee-action@v2
        with:
          args: --no-progress --offline '**/*.md'
          fail: true
